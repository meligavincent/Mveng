# Mveng - African AI Assistant
# Makefile for Docker operations

.PHONY: help build up down logs shell clean restart status health

# Default target
help: ## Show this help message
	@echo "ğŸŒ Mveng - African AI Assistant"
	@echo "================================"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Development commands
dev: ## Start development environment (minimal services)
	@echo "ğŸš€ Starting Mveng development environment..."
	docker-compose up mveng redis

build: ## Build the Mveng Docker image
	@echo "ğŸ”¨ Building Mveng Docker image..."
	docker-compose build mveng

up: ## Start all services
	@echo "ğŸŒŸ Starting all Mveng services..."
	docker-compose up -d

down: ## Stop all services
	@echo "ğŸ›‘ Stopping all Mveng services..."
	docker-compose down

restart: ## Restart all services
	@echo "ğŸ”„ Restarting Mveng services..."
	docker-compose restart

# Service-specific commands
up-core: ## Start core services (mveng + redis)
	@echo "ğŸ¯ Starting core Mveng services..."
	docker-compose up -d mveng redis

up-ai: ## Start with AI services (ollama)
	@echo "ğŸ¤– Starting Mveng with AI services..."
	docker-compose up -d mveng redis ollama

up-full: ## Start with database
	@echo "ğŸ—„ï¸ Starting full Mveng stack..."
	docker-compose --profile database up -d

up-prod: ## Start production environment
	@echo "ğŸ­ Starting Mveng production environment..."
	docker-compose --profile production --profile database up -d

# Monitoring and debugging
logs: ## Show logs for all services
	docker-compose logs -f

logs-mveng: ## Show logs for Mveng service only
	docker-compose logs -f mveng

status: ## Show status of all services
	@echo "ğŸ“Š Mveng Services Status:"
	docker-compose ps

health: ## Check health of all services
	@echo "ğŸ¥ Mveng Health Check:"
	@echo "API Server:"
	@curl -s http://localhost:3000/hello | jq . || echo "âŒ API not responding"
	@echo "Redis:"
	@docker-compose exec redis redis-cli ping || echo "âŒ Redis not responding"

shell: ## Get shell access to Mveng container
	docker-compose exec mveng /bin/bash

shell-redis: ## Get Redis CLI access
	docker-compose exec redis redis-cli

# Maintenance commands
clean: ## Clean up containers and volumes
	@echo "ğŸ§¹ Cleaning up Mveng environment..."
	docker-compose down -v
	docker system prune -f

clean-all: ## Nuclear clean - remove everything
	@echo "ğŸ’¥ Nuclear clean - removing all Mveng data..."
	docker-compose down -v --rmi all
	docker system prune -af

# Ollama management
ollama-pull: ## Pull Llama2 model for Ollama
	@echo "ğŸ“¥ Pulling Llama2 model..."
	docker-compose exec ollama ollama pull llama2

ollama-list: ## List available Ollama models
	docker-compose exec ollama ollama list

# Database operations (when using database profile)
db-migrate: ## Run database migrations
	@echo "ğŸ“Š Running database migrations..."
	# Add your migration commands here

db-shell: ## Access PostgreSQL shell
	docker-compose exec postgres psql -U mveng -d mveng

# Testing
test-api: ## Test API endpoints
	@echo "ğŸ§ª Testing Mveng API..."
	@echo "Hello endpoint:"
	@curl -s http://localhost:3000/hello | jq .
	@echo "Mveng endpoint:"
	@curl -s http://localhost:3000/mveng | jq .

# Environment setup
install: ## Install and setup everything
	@echo "âš™ï¸ Setting up Mveng environment..."
	make build
	make up-core
	@echo "âœ… Mveng is ready!"
	@echo "ğŸŒ API: http://localhost:3000"
	@echo "ğŸ“š Swagger: http://localhost:3000/swagger-ui"

# Quick commands
quick-start: build up-core ## Build and start core services quickly

# Info
info: ## Show environment information
	@echo "ğŸŒ Mveng Environment Information"
	@echo "==============================="
	@echo "API Server: http://localhost:3000"
	@echo "Swagger UI: http://localhost:3000/swagger-ui"
	@echo "Redis: localhost:6379"
	@echo "Ollama: http://localhost:11434"
	@echo "Whisper: http://localhost:8001"
	@echo ""
	@echo "ğŸ³ Docker Status:"
	@docker --version
	@docker-compose --version